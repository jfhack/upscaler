# Upscaler

A Docker image and a script that make it easy to upscale and restore images, using [ruDALL-E](https://github.com/ai-forever/ru-dalle), [Real-ESRGAN](https://github.com/xinntao/Real-ESRGAN), and [GFPGAN](https://github.com/TencentARC/GFPGAN).

⚠️ The size of this Docker image is about 19GB for x86_64 architectures and about 17GB for ARM64 (only tested on Jetson Xavier NX 8GB).

## Usage

### Basic Usage

In the `experiments` directory, create a subdirectory where your images will be, for example: `input`.

To run, for example, model version `1.3` of [GFPGAN](https://github.com/TencentARC/GFPGAN), you can execute:

```sh
./upscaler input output g:1.3
```

At first, it will download the Docker image `ghcr.io/jfhack/upscaler:latest`. Then, it will process all the images from the `input` directory with model version `1.3` of [GFPGAN](https://github.com/TencentARC/GFPGAN), and finally, it will save them in the `output` directory.

### Arguments

|Arguments|Description|
|-|-|
|`input`|input directory|
|`output`|output directory|
|`model`|model to use; one of the following:<br><br>g:1<br>g:1.2<br>g:1.3<br>g:1.4<br>g:RestoreFormer<br>r:RealESRGAN_x2plus<br>r:RealESRGAN_x4plus<br>r:RealESRGAN_x4plus_anime_6B<br>r:RealESRNet_x4plus<br>r:realesr-animevideov3<br>r:realesr-general-x4v3<br>rudalle<br><br>If the model is `all`, it will run all models.<br>You can use more models by joining them with a comma without any spaces, e.g., `g:1.3,r:RealESRGAN_x4plus`. This will generate a subdirectory for each model in the output directory, using lowercased and underscored model names as subdirectory names; for example, `r:RealESRGAN_x4plus_anime_6B` will be `r_realesrgan_x4plus_anime_6b`|
|`--uid UID`|user ID; since the Docker image uses a root account, everything it creates will be under that account, but once finished, these IDs will be used. By default, it uses those of the user who runs the script|
|`--gid GID`|group ID; the same as user ID but for the group|
|`--compare COMPARE`|name of the image to compare against; it is required to have used at least two models since they create the expected subdirectories. It will create a subdirectory called `comparison` with a link to the original image, and the images generated by the models|
|`-s SCALE`, `--scale SCALE`|upscaling factor; default is 2|
|`--force-png-output`|force output to be in PNG format|
|`--gfpgan-args`|[GFPGAN](https://github.com/TencentARC/GFPGAN) original arguments|
|`--realesrgan-args`|[Real-ESRGAN](https://github.com/xinntao/Real-ESRGAN) original arguments. Note: if you want to use with `--gfpgan-args`, you must use them in this order: `--realesrgan-args ... --gfpgan-args ...`|

### Example

Suppose you have the following structure in the `experiments` directory:
```
input/sample.jpg
```
By executing the command `./upscaler input output all --force-png-output`, the resulting structure will be:
```
output/g_1/sample.png
output/g_1.2/sample.png
output/g_1.3/sample.png
output/g_1.4/sample.png
output/g_restoreformer/sample.png
output/r_realesr-animevideov3/sample.png
output/r_realesrgan_x2plus/sample.png
output/r_realesrgan_x4plus/sample.png
output/r_realesrgan_x4plus_anime_6b/sample.png
output/r_realesr-general-x4v3/sample.png
output/r_realesrnet_x4plus/sample.png
output/rudalle/sample.png
```
Each image will be upscaled by 2x

Additionally, if you execute `./upscaler input output all --compare sample.jpg`, a new directory called `comparison` will be created within the `output` directory. The structure of this directory will be:
```
output/...
output/comparison/g_1.2.png
output/comparison/g_1.3.png
output/comparison/g_1.4.png
output/comparison/g_1.png
output/comparison/g_restoreformer.png
output/comparison/original.jpg
output/comparison/r_realesr-animevideov3.png
output/comparison/r_realesrgan_x2plus.png
output/comparison/r_realesrgan_x4plus_anime_6b.png
output/comparison/r_realesrgan_x4plus.png
output/comparison/r_realesr-general-x4v3.png
output/comparison/r_realesrnet_x4plus.png
output/comparison/rudalle.png
```
In this structure, each image is symbolically linked to the image specified in the `--compare` argument, corresponding to their respective models and to the original image. This arrangement is particularly useful for quick comparisons, as all the images are located in the same directory

## Build

If you want to build the Docker image by yourself, you must execute the following commands:
```sh
cd src
./build.sh
```

However, please take into account that the PyTorch extensions required for [BasicSR](https://github.com/XPixelGroup/BasicSR/blob/master/docs/INSTALL.md#basicsr_ext-and-basicsr_jit-environment-variables) need CUDA to be available during the installation. To achieve this, you can follow these steps:

1. **Install `nvidia-container-runtime`:**<br>
  It's necessary to have the `nvidia-container-runtime` installed
   
2. **Configure Docker to use NVIDIA as the Default Runtime:**<br>
   Add the following line `"default-runtime": "nvidia"` to `/etc/docker/daemon.json`. 
   
   Here's an example of how the file might look:
   ```json
   {
       "runtimes": {
           "nvidia": {
               "path": "/usr/bin/nvidia-container-runtime",
               "runtimeArgs": []
           } 
       },
       "default-runtime": "nvidia" 
   }
   ```
   After editing the file, restart the Docker service using:
   ```sh
   sudo systemctl restart docker
   ```
   [source](https://stackoverflow.com/a/75629058/2913839)

3. **Use the Appropriate Environment Variable:**<br>
   You'll also need to use the environment variable `DOCKER_BUILDKIT=0`, but the script is already configured to use it<br>
   [source](https://stackoverflow.com/a/61737404/2913839)

By following these instructions, you'll ensure that the necessary conditions are met to build the Docker image